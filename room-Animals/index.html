 <script>
/* ====== CONFIG ====== */
/* Keep your existing FILES_FALLBACK list here. */
const FILES_FALLBACK = [
  "Screen Shot 2025-09-08 at 8.57.00 AM.png",
  "Screen Shot 2025-09-08 at 8.57.30 AM.png",
  "Screen Shot 2025-09-08 at 8.57.34 AM.png",
  "Screen Shot 2025-09-08 at 8.58.29 AM.png",
  "Screen Shot 2025-09-08 at 9.00.26 AM.png",
  "Screen Shot 2025-09-08 at 9.00.46 AM.png",
  "Screen Shot 2025-09-08 at 9.01.14 AM.png",
  "Screen Shot 2025-09-08 at 9.04.36 AM.png",
  "Screen Shot 2025-09-08 at 9.05.04 AM.png",
  "Screen Shot 2025-09-08 at 9.06.16 AM.png",
  "Screen Shot 2025-09-08 at 9.06.29 AM.png",
  "Screen Shot 2025-09-08 at 9.07.13 AM.png",
  "Screen Shot 2025-09-08 at 9.07.45 AM.png",
  "Screen Shot 2025-09-08 at 9.08.34 AM.png"
];

/* Try these base folders in order. The first one should be correct
   for a page at room-Animals/index.html with images at room-Animals/img/.
   The others are just safety nets while you move files. */
const BASES = [
  new URL('img/', location.href).href,                 // ./img/
  new URL('../room-Animals/img/', location.href).href, // ../room-Animals/img/
  new URL('../img/', location.href).href               // ../img/
];

const ROOM_NAME = "Animals";
const cardsEl = document.getElementById('cards');
const lb = document.getElementById('lightbox');
const lbImg = document.getElementById('lightImg');
const closeBtn = document.getElementById('closeBtn');

const prettyTitle = f => f.replace(/\.[^.]+$/,'').replace(/[_-]+/g,' ').replace(/\s+/g,' ').trim();
const enc = s => encodeURIComponent(s).replace(/%2F/gi,'/'); // keep any slashes if present

async function loadFiles(){
  try{
    const r = await fetch('files.json', {cache:'no-store'});
    if(!r.ok) throw 0;
    const list = await r.json();
    if(!Array.isArray(list) || !list.length) throw 0;
    return list;
  }catch{ return FILES_FALLBACK; }
}
async function loadCaptions(){
  try{
    const r = await fetch('captions.json', {cache:'no-store'});
    if(!r.ok) throw 0;
    const map = await r.json();
    return (map && typeof map === 'object') ? map : {};
  }catch{ return {}; }
}

function buildCard(file, caption){
  const title = caption?.title || prettyTitle(file);
  const desc  = caption?.desc  || "Add a description for this artwork in captions.json.";

  // Generate candidate URLs across all base paths
  const candidates = BASES.map(b => b + enc(file));

  const card = document.createElement('article');
  card.className = 'card';
  card.innerHTML = `
    <a href="#" class="frame">
      <div class="tile">
        <img alt="${title}" decoding="async" loading="lazy">
        <div class="missing" hidden>Missing:<br><code>${file}</code><br>
          <small><a class="trylink" href="#" target="_blank" rel="noopener">open attempted URL</a></small>
        </div>
      </div>
    </a>
    <div class="meta">
      <h3>${title}</h3>
      <p class="sub"><strong>${ROOM_NAME}</strong> Â·
        <code style="font-size:.9rem;color:#a9d7c3">${file}</code></p>
      <p>${desc}</p>
    </div>
  `;
  const img  = card.querySelector('img');
  const miss = card.querySelector('.missing');
  const link = card.querySelector('.frame');
  const trylink = card.querySelector('.trylink');

  let i = 0;
  function tryNext(){
    if (i >= candidates.length){
      miss.hidden = false;
      trylink.href = candidates[candidates.length - 1]; // show last tried
      img.style.objectFit = 'contain';
      img.style.background = '#2a2f3a';
      return;
    }
    const src = candidates[i++];
    trylink.href = src;
    img.src = src;
  }
  img.addEventListener('error', tryNext);
  img.addEventListener('load', () => { miss.hidden = true; });
  tryNext();

  link.addEventListener('click', (e) => {
    e.preventDefault();
    if (img.src) openLightbox(img.src, img.alt);
  });
  return card;
}

function openLightbox(src, alt){
  lbImg.src = src; lbImg.alt = alt;
  lb.classList.add('open'); document.body.style.overflow = 'hidden';
}
function closeLightbox(){
  lb.classList.remove('open'); lbImg.src = '';
  document.body.style.overflow = '';
}
lb.addEventListener('click', (e)=>{ if(e.target === lb) closeLightbox(); });
closeBtn.addEventListener('click', closeLightbox);
document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closeLightbox(); });

let currentFiles = [], currentCaptions = {};
(async function init(){
  currentFiles = await loadFiles();
  currentCaptions = await loadCaptions();
  cardsEl.innerHTML = '';
  currentFiles.forEach(f => cardsEl.appendChild(buildCard(f, currentCaptions[f])));
})();
</script>
